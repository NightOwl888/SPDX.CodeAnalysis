name: Test Powershell Scripts

on:
  workflow_dispatch:
  push:
  pull_request:
  
jobs:
  pester:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Restore Powershell Dependencies
        shell: pwsh
        run: ./.build/Ensure-Powershell-Dependencies.ps1

      - name: Run Pester Tests
        shell: pwsh
        run: |
          #$tests = Get-ChildItem -Path '.build' -Recurse -Filter '*.Tests.ps1' | ForEach-Object FullName
          $testResults = Invoke-Pester -Output Detailed -CI -PassThru
          $summaryMarkdown = @"
          ### Pester Test Results
          | Metric | Value |
          |---|---|
          | Total Tests | $($testResults.TotalCount) |
          | Passed | $($testResults.PassedCount) |
          | Failed | $($testResults.FailedCount) |
          | Skipped | $($testResults.SkippedCount) |
          "@
          $summaryMarkdown | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
